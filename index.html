<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>興起居服服務計算機</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Set Inter font */
        body {
            font-family: 'Inter', sans-serif;
            /* Lighter pink gradient background */
            background-image: linear-gradient(to bottom right, #ffe4e6, #fecaca); /* rose-100 to pink-200 */
            /* Single, larger, and slightly more visible heart pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M12 4.419c-2.826-5.695-11.999-4.064-11.999 3.27 0 7.27 9.999 10.931 11.999 14.311 2-3.38 11.999-7.041 11.999-14.311 0-7.334-9.173-8.964-11.999-3.27z' fill='%23fbcfe8' fill-opacity='0.6'/%3E%3C/svg%3E"), linear-gradient(to bottom right, #ffe4e6, #fecaca);
            background-repeat: no-repeat, no-repeat; /* No repeat for pattern and gradient */
            background-position: center center, center center; /* Center pattern and gradient */
            background-size: 200px 200px, 100% 100%; /* pattern size, gradient size */
        }
        /* Removed CSS to hide number input arrows */
        input[type="number"] {
            -moz-appearance: textfield; /* Keep for Firefox compatibility if needed, but modern browsers usually handle it */
        }
        /* Hide spinner arrows for all number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Adjustments for responsive table columns */
        /* Removed specific overrides for th and td width */

        /* Custom style for Quantity column */
        .quantity-column {
            background-color: #e0f2fe; /* Light blue-100 for distinction */
            padding: 0; /* Remove padding from the TD itself */
        }
        .quantity-column input {
            text-align: center; /* Ensure input text is centered */
            padding: 1px; /* Minimal padding inside the input */
            height: auto; /* Let height adjust */
            line-height: normal; /* Ensure line height doesn't add extra space */
            font-size: 0.85em; /* Slightly smaller font for the number itself */
            min-width: 0; /* Allow it to shrink as much as possible */
        }

        /* Modal specific styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl w-full text-center">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-6">
            興起居服服務計算機
        </h1>

        <!-- User ID Display -->
        <div class="mb-4 text-sm text-gray-600 text-left">
            <p id="userIdDisplay">使用者 ID: 載入中...</p>
        </div>

        <!-- CMS Level & Identity Type Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label for="cmsLevel" class="block text-lg font-semibold text-gray-700 mb-2 text-left">選擇 CMS 等級:</label>
                <select id="cmsLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm text-gray-800">
                    <option value="">請選擇</option>
                    <option value="2">CMS 2</option>
                    <option value="3">CMS 3</option>
                    <option value="4">CMS 4</option>
                    <option value="5">CMS 5</option>
                    <option value="6">CMS 6</option>
                    <option value="7">CMS 7</option>
                    <option value="8">CMS 8</option>
                    <option value="自費">自費</option>
                </select>
            </div>
            <div>
                <label for="identityType" class="block text-lg font-semibold text-gray-700 mb-2 text-left">選擇身分別:</label>
                <select id="identityType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm text-gray-800">
                    <option value="一般戶">一般戶 (自付額 16%)</option>
                    <option value="中低收入戶">中低收入戶 (自付額 5%)</option>
                    <option value="低收入戶">低收入戶 (自付額 0%)</option>
                    <option value="自費">自付額 (100%)</option>
                </select>
            </div>
        </div>

        <!-- Subsidy Display -->
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded-lg mb-6 text-left">
            <p class="font-bold">CMS 補助金額:</p>
            <p id="subsidyAmount" class="text-2xl font-semibold mt-1">0 元</p>
        </div>

        <!-- Service Items Table -->
        <div class="overflow-x-auto mb-6">
            <table class="w-full border-collapse text-sm">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-300 p-0 rounded-tl-lg whitespace-normal">編號</th>
                        <th class="border border-gray-300 p-1 whitespace-normal">照顧組合</th>
                        <th class="border border-gray-300 p-1">全額 (元)</th>
                        <th class="border border-gray-300 p-1 quantity-column">組數</th>
                        <th class="border border-gray-300 p-1">項目總額 (元)</th>
                        <th class="border border-gray-300 p-1 rounded-tr-lg">項目自付額 (元)</th>
                    </tr>
                </thead>
                <tbody id="serviceItemsTableBody">
                    <!-- Service items will be dynamically inserted here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Other Services Section -->
        <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 text-left">
            <label class="block text-lg font-semibold text-gray-700 mb-2">是否使用其他服務?</label>
            <div class="flex items-center space-x-4 mb-3">
                <input type="radio" id="otherServicesYes" name="otherServicesOption" value="yes" class="form-radio text-blue-600 h-5 w-5">
                <label for="otherServicesYes" class="text-gray-700">是</label>
                <input type="radio" id="otherServicesNo" name="otherServicesOption" value="no" class="form-radio text-blue-600 h-5 w-5" checked>
                <label for="otherServicesNo" class="text-gray-700">否</label>
            </div>

            <div id="otherServicesInputContainer" class="hidden mb-3">
                <label for="otherServicesManualInput" class="block text-md font-semibold text-gray-700 mb-2">手動輸入已知使用服務費用(元)或點選選擇其他服務項目計算:</label>
                <input type="number" id="otherServicesManualInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm text-gray-800" value="0" min="0">
            </div>

            <button id="openOtherServicesModalBtn" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-full shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-blue-300">
                選擇其他服務項目 (日照、家托、專業服務等)
            </button>

            <!-- New: Remaining Subsidy Display -->
            <div id="remainingSubsidyDisplayContainer" class="hidden mt-3 bg-blue-50 border border-blue-300 text-blue-800 px-4 py-3 rounded-lg text-left">
                <p class="font-bold">已使用其他服務項目，目前可使用居服額度:</p>
                <p id="remainingSubsidyForMainServices" class="text-2xl font-semibold mt-1">0 元</p>
            </div>
        </div>

        <!-- Summary Totals (居服 only) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-left">
            <div class="bg-purple-100 border border-purple-400 text-purple-700 px-4 py-3 rounded-lg">
                <p class="font-bold">居服全額總計:</p>
                <p id="totalFullCost" class="text-2xl font-semibold mt-1">0 元</p>
            </div>
            <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg" id="selfPaymentSummaryBox">
                <p class="font-bold">居服自付額總計:</p>
                <p id="totalSelfPayment" class="text-2xl font-semibold mt-1">0 元</p>
            </div>
        </div>

        <!-- Subsidy Comparison Result -->
        <div id="subsidyComparisonBox"
            class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6 text-left">
            <p class="font-bold">補助比對結果:</p>
            <p id="subsidyComparisonResult" class="text-2xl font-semibold mt-1">請選擇 CMS 等級並輸入服務項目</p>
        </div>

        <!-- New: Final Cost Breakdown Section (Conditional Display) -->
        <div id="finalCostBreakdownContainer" class="hidden mt-6 p-4 border border-gray-200 rounded-lg bg-indigo-50 text-left">
            <h3 class="text-xl font-bold text-gray-800 mb-3">總服務費用實際分擔</h3>
            <p class="font-bold text-lg">居服可用補助: <span id="mainServicesCmsAvailableSubsidy" class="text-indigo-700">0 元</span></p>
            <p class="font-bold text-lg">居服補助下應付自付額: <span id="estimatedMainServicesUserSelfPayUnderSubsidy" class="text-indigo-700">0 元</span></p>
            <p class="font-bold text-lg">居服全額自費: <span id="estimatedMainServicesFullSelfPay" class="text-indigo-700">0 元</span></p>
            <p class="font-bold text-lg">預估居服應負總額: <span id="estimatedMainServicesTotalEstimatedPay" class="text-indigo-700">0 元</span></p>
            <p class="text-xs text-gray-600 mt-4">
                備註：<br>
                居服可用補助 = 已使用其他服務項目，目前可使用居服額度<br>
                居服補助下應付自付額 = 居服可用補助 * 身分別自付額比例<br>
                居服全額自費 = 居服全額總計 - 居服可用補助 (若為負值則為0)<br>
                預估居服應負總額 = 居服補助下應付自付額 + 居服全額自費
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap justify-center gap-4 mt-6">
            <button id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-full shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-green-300">
                重新計算
            </button>
        </div>

        <!-- Export Data Section -->
        <div class="mt-8 p-6 border border-gray-200 rounded-xl bg-gray-50 text-left">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">數據匯出 (手動備份)</h2>
            <p class="text-gray-700 mb-4">您可以將當前計算數據匯出為文字，儲存到記事本或其他地方。</p>

            <div class="mb-4">
                <label for="exportDataTextarea" class="block text-lg font-semibold text-gray-700 mb-2">匯出數據 (複製以下文字):</label>
                <textarea id="exportDataTextarea" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 font-mono text-sm h-32 resize-y"></textarea>
                <div class="flex flex-wrap justify-start gap-4 mt-2">
                    <button id="exportDataBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-full shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-purple-300">
                        匯出當前數據
                    </button>
                    <button id="copyDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-full shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-blue-300">
                        複製數據
                    </button>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox"
            class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative"
            role="alert">
            <span class="block sm:inline" id="messageText"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('messageBox').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>關閉</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
            </span>
        </div>
    </div>

    <!-- Other Services Modal -->
    <div id="otherServicesModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="closeOtherServicesModalBtn">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">選擇其他服務項目</h2>
            <div class="overflow-x-auto mb-4">
                <table class="w-full border-collapse text-sm">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-0 rounded-tl-lg whitespace-normal">編號</th>
                            <th class="border border-gray-300 p-1 whitespace-normal">照顧組合</th>
                            <th class="border border-gray-300 p-1">全額 (元)</th>
                            <th class="border border-gray-300 p-1 quantity-column">組數</th>
                            <th class="border border-gray-300 p-1">項目總額 (元)</th>
                            <th class="border border-gray-300 p-1 rounded-tr-lg">項目自付額 (元)</th>
                        </tr>
                    </thead>
                    <tbody id="otherServiceItemsTableBody">
                        <!-- Other service items will be dynamically inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="text-right mt-4">
                <p class="font-bold text-lg">其他服務項目總計 (全額): <span id="modalOtherServicesTotalFullCost">0</span> 元</p>
                <p class="font-bold text-lg">其他服務項目總計 (自付額): <span id="modalOtherServicesTotalSelfPayment">0</span> 元</p>
            </div>
            <button id="confirmOtherServicesBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-5 rounded-full shadow-md transition-all duration-200 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-green-300 mt-4">
                確認選擇並關閉
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const cmsLevelSelect = document.getElementById('cmsLevel');
        const identityTypeSelect = document.getElementById('identityType');
        const subsidyAmountDisplay = document.getElementById('subsidyAmount');
        const serviceItemsTableBody = document.getElementById('serviceItemsTableBody');
        const totalFullCostDisplay = document.getElementById('totalFullCost'); // Now "居服全額總計"
        const totalSelfPaymentDisplay = document.getElementById('totalSelfPayment'); // Now "居服自付額總計"
        const selfPaymentSummaryBox = document.querySelector('#selfPaymentSummaryBox'); // Get the parent div for hiding/showing
        const subsidyComparisonBox = document.getElementById('subsidyComparisonBox');
        const subsidyComparisonResultDisplay = document.getElementById('subsidyComparisonResult');
        const saveBtn = document.getElementById('saveBtn'); // Now "重新計算" button
        const userIdDisplay = document.getElementById('userIdDisplay');
        const exportDataTextarea = document.getElementById('exportDataTextarea');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const copyDataBtn = document.getElementById('copyDataBtn');

        const otherServicesYesRadio = document.getElementById('otherServicesYes');
        const otherServicesNoRadio = document.getElementById('otherServicesNo');
        const otherServicesInputContainer = document.getElementById('otherServicesInputContainer');
        const otherServicesManualInput = document.getElementById('otherServicesManualInput');
        const openOtherServicesModalBtn = document.getElementById('openOtherServicesModalBtn');
        const remainingSubsidyDisplayContainer = document.getElementById('remainingSubsidyDisplayContainer');
        const remainingSubsidyForMainServicesElement = document.getElementById('remainingSubsidyForMainServices');

        // New DOM elements for final cost breakdown
        const finalCostBreakdownContainer = document.getElementById('finalCostBreakdownContainer'); // Get the container itself
        const mainServicesCmsAvailableSubsidyElement = document.getElementById('mainServicesCmsAvailableSubsidy'); // Renamed ID
        const estimatedMainServicesUserSelfPayUnderSubsidyElement = document.getElementById('estimatedMainServicesUserSelfPayUnderSubsidy');
        const estimatedMainServicesFullSelfPayElement = document.getElementById('estimatedMainServicesFullSelfPay');
        const estimatedMainServicesTotalEstimatedPayElement = document.getElementById('estimatedMainServicesTotalEstimatedPay');


        const otherServicesModal = document.getElementById('otherServicesModal');
        const closeOtherServicesModalBtn = document.getElementById('closeOtherServicesModalBtn');
        const otherServiceItemsTableBody = document.getElementById('otherServiceItemsTableBody');
        const modalOtherServicesTotalFullCost = document.getElementById('modalOtherServicesTotalFullCost');
        const modalOtherServicesTotalSelfPayment = document.getElementById('modalOtherServicesTotalSelfPayment');
        const confirmOtherServicesBtn = document.getElementById('confirmOtherServicesBtn');

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Data Definitions
        const cmsSubsidies = {
            '2': 10020, '3': 15460, '4': 18580, '5': 24100,
            '6': 28070, '7': 32090, '8': 36180,
            '自費': 0
        };

        const identitySelfPaymentRates = {
            '一般戶': 0.16,
            '中低收入戶': 0.05,
            '低收入戶': 0,
            '自費': 1
        };

        const serviceItems = [
            { code: 'BA01', name: '基本身體清潔', fullCost: 260 }, { code: 'BA02', name: '基本日常生活照顧', fullCost: 195 },
            { code: 'BA03', name: '測量生命徵象', fullCost: 35 }, { code: 'BA04', name: '協助進食餵食', fullCost: 130 },
            { code: 'BA05', name: '餐食照顧', fullCost: 310 }, { code: 'BA07', name: '沐浴及洗頭', fullCost: 325 },
            { code: 'BA08', name: '足部照護', fullCost: 500 }, { code: 'BA10', name: '翻身拍背', fullCost: 155 },
            { code: 'BA11', name: '肢體關節活動', fullCost: 195 }, { code: 'BA12', name: '協助上下樓', fullCost: 130 },
            { code: 'BA13', name: '陪同外出', fullCost: 195 }, { code: 'BA14', name: '陪同就醫', fullCost: 685 },
            { code: 'BA15', name: '家務協助', fullCost: 195 },
            { code: 'BA15-2', name: '家務協助 (共用)', fullCost: 195 }, // Renamed
            { code: 'BA16', name: '代購代領', fullCost: 130 },
            { code: 'BA16-2', name: '代購代領 (共用)', fullCost: 130 }, // Renamed
            { code: 'BA17a', name: '人工氣道管內分泌物抽吸', fullCost: 75 }, { code: 'BA17b', name: '口腔分泌物抽吸', fullCost: 65 },
            { code: 'BA17c', name: '管路清潔', fullCost: 50 }, { code: 'BA17d1', name: '血糖機驗血糖', fullCost: 50 },
            { code: 'BA17d2', name: '甘油球通便', fullCost: 50 }, { code: 'BA17e', name: '分藥入藥盒', fullCost: 50 },
            { code: 'BA18', name: '安全看視', fullCost: 200 }, { code: 'BA20', name: '陪伴服務', fullCost: 175 },
            { code: 'BA22', name: '巡視服務', fullCost: 130 }, { code: 'BA23', name: '協助洗頭', fullCost: 200 },
            { code: 'BA24', name: '協助排泄', fullCost: 220 }
        ];

        const otherServiceItems = [
            // BB Series
            { code: 'BB01', name: '日間照顧 (全日) -- 第1型(2級-14天)', fullCost: 675 },
            { code: 'BB03', name: '日間照顧 (全日) -- 第2型(3級-18天)', fullCost: 840 },
            { code: 'BB05', name: '日間照顧 (全日) -- 第3型(4級-20天)', fullCost: 920 },
            { code: 'BB07', name: '日間照顧 (全日) -- 第4型(5級-23天)', fullCost: 1045 },
            { code: 'BB09', name: '日間照顧 (全日) -- 第5型(6級-24天)', fullCost: 1130 },
            { code: 'BB11', name: '日間照顧 (全日) -- 第6型(7級-26天)', fullCost: 1210 },
            { code: 'BB13', name: '日間照顧 (全日) -- 第7型(8級-28天)', fullCost: 1285 },
            // BD Series
            { code: 'BD01', name: '社區式協助沐浴', fullCost: 200 },
            { code: 'BD02', name: '社區式晚餐', fullCost: 150 },
            { code: 'BD03', name: '社區式服務交通接送(10公里內)', fullCost: 100 },
            // BC Series
            { code: 'BC01', name: '家庭托顧 (全日) -- 第1型(2級-16天)', fullCost: 625 },
            { code: 'BC03', name: '家庭托顧 (全日) -- 第2型(3級-20天)', fullCost: 760 },
            { code: 'BC05', name: '家庭托顧 (全日) -- 第3型(4級-23天)', fullCost: 785 },
            { code: 'BC07', name: '家庭托顧 (全日) -- 第4型(5級-27天)', fullCost: 880 },
            { code: 'BC09', name: '家庭托顧 (全日) -- 第5型(6級-29天)', fullCost: 960 },
            { code: 'BC11', name: '家庭托顧 (全日) -- 第6型(7級-32天)', fullCost: 980 },
            { code: 'BC13', name: '家庭托顧 (全日) -- 第7型(8級-34天)', fullCost: 1040 },
            // CA Series
            { code: 'CA07', name: 'IADLs、ADLs 復能照護(3次)', fullCost: 4500 },
            { code: 'CA08', name: '個別化服務計畫 (ISP) 擬定與執行(4次)', fullCost: 6000 },
            // CB Series
            { code: 'CB01', name: '營養照護(4次)', fullCost: 4000 },
            { code: 'CB02', name: '進食與吞嚥照護(6次)', fullCost: 9000 },
            { code: 'CB03', name: '困擾行為照護(3次)', fullCost: 4500 },
            { code: 'CB04', name: '臥床或長期活動受限照護(6次)', fullCost: 9000 },
            // CD Series (assuming CD02 is from CD series based on image)
            { code: 'CD02', name: '居家護理指導與諮詢(4次)', fullCost: 6000 },
            // CC Series
            { code: 'CC01', name: '居家環境安全或無障礙空間規劃', fullCost: 2000 }
        ];


        // Store current quantities for each service item (main table)
        const serviceQuantities = {};
        // Store current quantities for other service items (modal table)
        const otherServiceQuantities = {};

        // Firebase variables
        let app;
        let db;
        let auth;
        let userId = 'anonymous';
        const appIdFromEnv = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthTokenFromEnv = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Function to show message box
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            if (type === 'error') {
                messageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // Function to render service items table (main table and modal table)
        function renderServiceItems(targetTableBody, items, quantitiesMap) {
            targetTableBody.innerHTML = '';
            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-150';
                row.innerHTML = `
                    <td class="border border-gray-300 p-0 text-center font-medium whitespace-normal">${item.code}</td>
                    <td class="border border-gray-300 p-1 text-left whitespace-normal">${item.name}</td>
                    <td class="border border-gray-300 p-1 text-right">${item.fullCost.toLocaleString()}</td>
                    <td class="border border-gray-300 text-center quantity-column">
                        <input type="number" data-code="${item.code}" class="quantity-input w-full h-auto text-center focus:outline-none focus:ring-2 focus:ring-blue-300 rounded-lg" value="${quantitiesMap[item.code] || 0}" min="0" onfocus="if(this.value == '0') this.value = '';" onblur="this.value = parseInt(this.value, 10) || 0;">
                    </td>
                    <td class="border border-gray-300 p-1 text-right font-semibold" id="itemTotal-${item.code}">0</td>
                    <td class="border border-gray-300 p-1 text-right font-semibold" id="itemSelfPayment-${item.code}">0</td>
                `;
                targetTableBody.appendChild(row);
                if (quantitiesMap[item.code] === undefined) {
                    quantitiesMap[item.code] = 0;
                }
            });
            targetTableBody.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const code = event.target.dataset.code;
                    let quantity = parseInt(event.target.value);
                    if (isNaN(quantity) || quantity < 0) {
                        quantity = 0;
                        event.target.value = 0;
                    }
                    quantitiesMap[code] = quantity;
                    // If this is the main table, recalculate all totals
                    if (targetTableBody === serviceItemsTableBody) {
                        calculateAllTotals();
                    } else { // If this is the modal table, only update modal totals
                        calculateModalOtherServicesTotals();
                    }
                });
            });
            // Initial calculation for the rendered table
            if (targetTableBody === serviceItemsTableBody) {
                calculateAllTotals();
            } else {
                calculateModalOtherServicesTotals();
            }
        }

        // Calculate and update totals for the main table
        function calculateAllTotals() {
            let currentCmsLevel = cmsLevelSelect.value;
            let currentIdentityType = identityTypeSelect.value;
            let currentSubsidy = cmsSubsidies[currentCmsLevel] || 0;
            let selfPaymentRate = identitySelfPaymentRates[currentIdentityType] || 0;

            let mainServicesFullCost = 0; // For "居服全額總計"
            let mainServicesSelfPayment = 0; // For "居服自付額總計"

            // Calculate for main service items (BA series)
            serviceItems.forEach(item => {
                const quantity = serviceQuantities[item.code] || 0;
                const itemFullTotal = item.fullCost * quantity;
                let itemSelfPayment;

                // Special calculation for BA15-2 and BA16-2
                if (item.code === 'BA15-2' || item.code === 'BA16-2') {
                    if (currentIdentityType === '自費') {
                        itemSelfPayment = itemFullTotal;
                    } else {
                        const intermediateResult = Math.floor(itemFullTotal / 2);
                        const X = intermediateResult * selfPaymentRate;
                        itemSelfPayment = Math.floor(intermediateResult + X);
                    }
                } else {
                    itemSelfPayment = (currentIdentityType === '自費') ? itemFullTotal : Math.floor(itemFullTotal * selfPaymentRate);
                }

                mainServicesFullCost += itemFullTotal;
                mainServicesSelfPayment += itemSelfPayment;

                document.getElementById(`itemTotal-${item.code}`).textContent = itemFullTotal.toLocaleString();
                document.getElementById(`itemSelfPayment-${item.code}`).textContent = itemSelfPayment.toLocaleString();
            });

            // Calculate other services cost (full cost and self-payment)
            let otherServicesFullCost = 0;
            let otherServicesSelfPayment = 0;

            if (otherServicesYesRadio.checked) {
                const manualInputVal = parseFloat(otherServicesManualInput.value);
                if (!isNaN(manualInputVal) && manualInputVal > 0) {
                    otherServicesFullCost = manualInputVal;
                    // For manual input, self-payment is calculated directly
                    otherServicesSelfPayment = (currentIdentityType === '自費') ? otherServicesFullCost : Math.floor(otherServicesFullCost * selfPaymentRate);
                } else {
                    otherServiceItems.forEach(item => {
                        const quantity = otherServiceQuantities[item.code] || 0;
                        const itemFullTotal = item.fullCost * quantity;
                        let itemSelfPayment;

                        itemSelfPayment = (currentIdentityType === '自費') ? itemFullTotal : Math.floor(itemFullTotal * selfPaymentRate);

                        otherServicesFullCost += itemFullTotal;
                        otherServicesSelfPayment += itemSelfPayment;
                    });
                }
            }

            // Update main display totals (only BA series)
            totalFullCostDisplay.textContent = `${mainServicesFullCost.toLocaleString()} 元`;
            totalSelfPaymentDisplay.textContent = `${Math.floor(mainServicesSelfPayment).toLocaleString()} 元`;

            // Calculate and display remaining subsidy for main services
            const remainingForMainServices = currentSubsidy - otherServicesFullCost;
            remainingSubsidyForMainServicesElement.textContent = `${Math.floor(remainingForMainServices).toLocaleString()} 元`;

            // Update CMS subsidy display (this remains the same)
            subsidyAmountDisplay.textContent = `${currentSubsidy.toLocaleString()} 元`;

            // The subsidy comparison should now compare CMS subsidy with the *total* full cost from ALL services
            const overallTotalFullCost = mainServicesFullCost + otherServicesFullCost;
            updateSubsidyComparison(currentSubsidy, overallTotalFullCost);

            // --- Calculations for "預估" section ---
            let mainServicesCmsAvailableSubsidy = 0; // 居服可用補助
            let estimatedMainServicesUserSelfPayUnderSubsidy = 0; // 居服補助下應付自付額
            let estimatedMainServicesFullSelfPay = 0; // 居服全額自費
            let estimatedMainServicesTotalEstimatedPay = 0; // 預估居服應負總額

            if (currentIdentityType === '自費') {
                mainServicesCmsAvailableSubsidy = 0;
                estimatedMainServicesUserSelfPayUnderSubsidy = 0;
                estimatedMainServicesFullSelfPay = mainServicesFullCost;
                estimatedMainServicesTotalEstimatedPay = mainServicesFullCost;
            } else {
                // 居服可用補助 (=已使用其他服務項目，目前可使用居服額度:)
                mainServicesCmsAvailableSubsidy = Math.max(0, remainingForMainServices);

                // 居服補助下應付自付額 (=居服可用補助 * 身分別)
                estimatedMainServicesUserSelfPayUnderSubsidy = Math.floor(mainServicesCmsAvailableSubsidy * selfPaymentRate);

                // 居服全額自費:(居服全額總計-居服可用補助)
                estimatedMainServicesFullSelfPay = Math.max(0, mainServicesFullCost - mainServicesCmsAvailableSubsidy);

                // 預估居服應負總額(居服補助下應付自付額+居服全額自費)
                estimatedMainServicesTotalEstimatedPay = estimatedMainServicesUserSelfPayUnderSubsidy + estimatedMainServicesFullSelfPay;
            }

            // Update new display section
            mainServicesCmsAvailableSubsidyElement.textContent = `${Math.floor(mainServicesCmsAvailableSubsidy).toLocaleString()} 元`;
            estimatedMainServicesUserSelfPayUnderSubsidyElement.textContent = `${Math.floor(estimatedMainServicesUserSelfPayUnderSubsidy).toLocaleString()} 元`;
            estimatedMainServicesFullSelfPayElement.textContent = `${Math.floor(estimatedMainServicesFullSelfPay).toLocaleString()} 元`;
            estimatedMainServicesTotalEstimatedPayElement.textContent = `${Math.floor(estimatedMainServicesTotalEstimatedPay).toLocaleString()} 元`;
        }

        // Calculate and update totals for the modal table
        function calculateModalOtherServicesTotals() {
            let currentIdentityType = identityTypeSelect.value;
            let selfPaymentRate = identitySelfPaymentRates[currentIdentityType] || 0;

            let modalTotalFullCost = 0;
            let modalTotalSelfPayment = 0;

            otherServiceItems.forEach(item => {
                const quantity = otherServiceQuantities[item.code] || 0;
                const itemFullTotal = item.fullCost * quantity;
                let itemSelfPayment;

                // Other services (BB, BD, BC, CA, CB, CC) use the same calculation as BA items (general rule)
                itemSelfPayment = (currentIdentityType === '自費') ? itemFullTotal : Math.floor(itemFullTotal * selfPaymentRate);

                modalTotalFullCost += itemFullTotal;
                modalTotalSelfPayment += itemSelfPayment;

                const itemTotalElement = otherServicesModal.querySelector(`#itemTotal-${item.code}`);
                const itemSelfPaymentElement = otherServicesModal.querySelector(`#itemSelfPayment-${item.code}`);

                if (itemTotalElement) itemTotalElement.textContent = itemFullTotal.toLocaleString();
                if (itemSelfPaymentElement) itemSelfPaymentElement.textContent = itemSelfPayment.toLocaleString();
            });

            modalOtherServicesTotalFullCost.textContent = modalTotalFullCost.toLocaleString();
            modalOtherServicesTotalSelfPayment.textContent = Math.floor(modalTotalSelfPayment).toLocaleString();
        }


        // Update subsidy comparison result and conditional display of finalCostBreakdownContainer
        function updateSubsidyComparison(subsidy, fullCost) {
            const remaining = Math.floor(subsidy - fullCost);
            if (subsidy === 0 && cmsLevelSelect.value !== '自費') {
                subsidyComparisonResultDisplay.textContent = '請選擇 CMS 等級以比對補助。';
                subsidyComparisonBox.classList.remove('bg-green-100', 'bg-red-100', 'border-green-400', 'border-red-400', 'text-green-700', 'text-red-700', 'bg-gray-100', 'border-gray-400', 'text-gray-700');
                subsidyComparisonBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                finalCostBreakdownContainer.classList.add('hidden'); // Hide breakdown when not exceeded
                selfPaymentSummaryBox.classList.remove('hidden'); // Show self-payment summary
            } else if (cmsLevelSelect.value === '自費') {
                subsidyComparisonResultDisplay.textContent = '自費項目無補助比對。';
                subsidyComparisonBox.classList.remove('bg-green-100', 'bg-red-100', 'border-green-400', 'border-red-400', 'text-green-700', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
                subsidyComparisonBox.classList.add('bg-gray-100', 'border-gray-400', 'text-gray-700');
                finalCostBreakdownContainer.classList.add('hidden'); // Hide breakdown when not exceeded
                selfPaymentSummaryBox.classList.remove('hidden'); // Show self-payment summary
            }
            else if (remaining >= 0) {
                subsidyComparisonResultDisplay.textContent = `補助有剩餘：${remaining.toLocaleString()} 元`;
                subsidyComparisonBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-gray-100', 'border-gray-400', 'text-gray-700');
                subsidyComparisonBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                finalCostBreakdownContainer.classList.add('hidden'); // Hide breakdown when not exceeded
                selfPaymentSummaryBox.classList.remove('hidden'); // Show self-payment summary
            } else {
                subsidyComparisonResultDisplay.textContent = `補助已超出：${Math.abs(remaining).toLocaleString()} 元`;
                subsidyComparisonBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-gray-100', 'border-gray-400', 'text-gray-700');
                subsidyComparisonBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                finalCostBreakdownContainer.classList.remove('hidden'); // Show only when exceeded
                selfPaymentSummaryBox.classList.add('hidden'); // Hide self-payment summary when exceeded
            }
        }

        // Function to reset all quantities to zero (and dropdowns)
        function resetQuantities() {
            for (const code in serviceQuantities) {
                serviceQuantities[code] = 0;
            }
            for (const code in otherServiceQuantities) {
                otherServiceQuantities[code] = 0;
            }
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.value = 0;
            });
            cmsLevelSelect.value = '';
            identityTypeSelect.value = '一般戶';
            otherServicesNoRadio.checked = true; // Reset other services to "No"
            toggleOtherServicesInput(); // Hide other services input/modal button
            otherServicesManualInput.value = 0; // Reset manual input
            calculateAllTotals();
            showMessage('所有組數和選項已歸零！', 'info');
            window.scroll({ top: 0, left: 0, behavior: 'smooth' });
        }

        // Helper function to apply loaded data to the UI and internal model
        function applyLoadedData(data) {
            cmsLevelSelect.value = data.cmsLevel || '';
            identityTypeSelect.value = data.identityType || '一般戶';

            for (const key in serviceQuantities) {
                delete serviceQuantities[key];
            }
            Object.assign(serviceQuantities, data.serviceQuantities || {});

            for (const key in otherServiceQuantities) {
                delete otherServiceQuantities[key];
            }
            Object.assign(otherServiceQuantities, data.otherServiceQuantities || {});


            document.querySelectorAll('.quantity-input').forEach(input => {
                const code = input.dataset.code;
                if (serviceQuantities[code] !== undefined) {
                    input.value = serviceQuantities[code];
                } else if (otherServiceQuantities[code] !== undefined) {
                    input.value = otherServiceQuantities[code];
                } else {
                    input.value = 0;
                }
            });

            // Restore other services state
            if (data.otherServicesEnabled) {
                otherServicesYesRadio.checked = true;
                otherServicesManualInput.value = data.otherServicesManualValue || 0;
            } else {
                otherServicesNoRadio.checked = true;
            }
            toggleOtherServicesInput(); // Update UI based on restored state

            calculateAllTotals();
        }

        // --- Export Function ---
        function exportCurrentData() {
            let outputText = '';
            const cmsLevel = cmsLevelSelect.value;
            const identityType = identityTypeSelect.value;

            outputText += `CMS 等級: ${cmsLevel || '未選擇'}\n`;
            outputText += `身分別: ${identityType}\n\n`;

            outputText += "主要服務項目 (居服):\n";
            const mainServiceItemsMap = new Map(serviceItems.map(item => [item.code, item.name]));
            let hasMainServices = false;
            for (const code in serviceQuantities) {
                const quantity = serviceQuantities[code];
                if (quantity > 0) {
                    hasMainServices = true;
                    const name = mainServiceItemsMap.get(code) || code;
                    outputText += `${code} (${name})：${quantity}組\n`;
                }
            }
            if (!hasMainServices) {
                outputText += "無\n";
            }
            outputText += "\n";

            outputText += "其他服務:\n";
            if (otherServicesYesRadio.checked) {
                const manualInputVal = parseFloat(otherServicesManualInput.value);
                if (!isNaN(manualInputVal) && manualInputVal > 0) {
                    outputText += `手動輸入費用: ${manualInputVal.toLocaleString()} 元\n`;
                } else {
                    const otherServiceItemsMap = new Map(otherServiceItems.map(item => [item.code, item.name]));
                    let hasOtherServices = false;
                    for (const code in otherServiceQuantities) {
                        const quantity = otherServiceQuantities[code];
                        if (quantity > 0) {
                            hasOtherServices = true;
                            const name = otherServiceItemsMap.get(code) || code;
                            outputText += `${code} (${name})：${quantity}組\n`;
                        }
                    }
                    if (!hasOtherServices) {
                        outputText += "無 (已選擇使用其他服務，但未選擇具體項目)\n";
                    }
                }
            } else {
                outputText += "否 (未使用其他服務)\n";
            }
            outputText += "\n";

            // Add the new remaining subsidy info to export
            outputText += `已使用其他服務項目，目前可使用居服額度: ${remainingSubsidyForMainServicesElement.textContent}\n\n`;

            outputText += `居服全額總計: ${totalFullCostDisplay.textContent}\n`;
            // Conditionally export 居服自付額總計
            if (!selfPaymentSummaryBox.classList.contains('hidden')) {
                outputText += `居服自付額總計: ${totalSelfPaymentDisplay.textContent}\n`;
            }
            outputText += `補助比對結果: ${subsidyComparisonResultDisplay.textContent}\n`;

            // Only export breakdown if it's visible (i.e., subsidy exceeded)
            if (!finalCostBreakdownContainer.classList.contains('hidden')) {
                outputText += `\n總服務費用實際分擔:\n`;
                outputText += `  居服可用補助: ${mainServicesCmsAvailableSubsidyElement.textContent}\n`;
                outputText += `  居服補助下應付自付額: ${estimatedMainServicesUserSelfPayUnderSubsidyElement.textContent}\n`;
                outputText += `  居服全額自費: ${estimatedMainServicesFullSelfPayElement.textContent}\n`;
                outputText += `  預估居服應負總額: ${estimatedMainServicesTotalEstimatedPayElement.textContent}\n`;
                outputText += `  備註：\n`;
                outputText += `  居服可用補助 = 已使用其他服務項目，目前可使用居服額度\n`;
                outputText += `  居服補助下應付自付額 = 居服可用補助 * 身分別自付額比例\n`;
                outputText += `  居服全額自費 = 居服全額總計 - 居服可用補助 (若為負值則為0)\n`;
                outputText += `  預估居服應負總額 = 居服補助下應付自付額 + 居服全額自費\n`;
            }


            exportDataTextarea.value = outputText.trim();
            showMessage('數據已匯出，請複製上方文字！', 'info');
        }

        // --- Copy Exported Data Function ---
        function copyExportedData() {
            const textToCopy = exportDataTextarea.value;
            if (!textToCopy) {
                showMessage('沒有數據可以複製！', 'error');
                return;
            }
            exportDataTextarea.select();
            document.execCommand('copy');
            showMessage('數據已複製到剪貼簿！', 'success');
        }

        // Firebase Initialization and Data Operations
        async function initializeFirebaseAndLoadData() {
            try {
                app = initializeApp(firebaseConfigFromEnv);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `使用者 ID: ${userId}`;
                        console.log("Firebase authenticated. User ID:", userId);
                    } else {
                        if (initialAuthTokenFromEnv) {
                            await signInWithCustomToken(auth, initialAuthTokenFromEnv);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage('Firebase 初始化失敗，數據儲存功能可能無法使用。', 'error');
            }
        }

        // Toggle visibility of other services input/modal button and new remaining subsidy display
        function toggleOtherServicesInput() {
            if (otherServicesYesRadio.checked) {
                otherServicesInputContainer.classList.remove('hidden');
                openOtherServicesModalBtn.classList.remove('hidden');
                otherServicesManualInput.value = 0; // Reset manual input when modal option is available
                remainingSubsidyDisplayContainer.classList.remove('hidden'); // Show new display
            } else {
                otherServicesInputContainer.classList.add('hidden');
                openOtherServicesModalBtn.classList.add('hidden');
                // Clear all other service quantities when "No" is selected
                for (const code in otherServiceQuantities) {
                    otherServiceQuantities[code] = 0;
                }
                otherServicesManualInput.value = 0; // Ensure manual input is reset when "No" is selected
                remainingSubsidyDisplayContainer.classList.add('hidden'); // Hide new display
            }
            calculateAllTotals(); // Recalculate totals after changing other services option
        }

        // Event Listeners for dropdowns and buttons
        document.addEventListener('DOMContentLoaded', () => {
            cmsLevelSelect.addEventListener('change', calculateAllTotals);
            identityTypeSelect.addEventListener('change', calculateAllTotals);
            saveBtn.addEventListener('click', () => resetQuantities());
            exportDataBtn.addEventListener('click', () => exportCurrentData());
            copyDataBtn.addEventListener('click', () => copyExportedData());

            otherServicesYesRadio.addEventListener('change', toggleOtherServicesInput);
            otherServicesNoRadio.addEventListener('change', toggleOtherServicesInput);
            otherServicesManualInput.addEventListener('input', calculateAllTotals);

            openOtherServicesModalBtn.addEventListener('click', () => {
                otherServicesModal.classList.remove('hidden');
                renderServiceItems(otherServiceItemsTableBody, otherServiceItems, otherServiceQuantities);
            });

            closeOtherServicesModalBtn.addEventListener('click', () => {
                otherServicesModal.classList.add('hidden');
                calculateAllTotals(); // Recalculate main totals after closing modal
            });

            confirmOtherServicesBtn.addEventListener('click', () => {
                otherServicesModal.classList.add('hidden');
                otherServicesManualInput.value = 0; // Clear manual input if modal is used
                calculateAllTotals(); // Recalculate main totals after confirming modal selection
            });

            try {
                renderServiceItems(serviceItemsTableBody, serviceItems, serviceQuantities); // Render main service items
            } catch (e) {
                console.error("Error rendering service items:", e);
                showMessage('表格內容載入失敗：' + e.message, 'error');
            }

            initializeFirebaseAndLoadData();
        });
    </script>
</body>
</html>
